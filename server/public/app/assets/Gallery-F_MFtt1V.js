import{z as ze,p as g,D as re,q as j,A as ee,_ as ne,H as ue,c as l,o as a,b as e,i as _,k as ae,y as se,e as U,I as O,t as f,F as le,G as oe,j as J,L as X,n as ie,x as ce,E as Me,h as Q,w as D,f as G,d as te,B as R,u as fe,v as Be,J as ge}from"./app-B9F_XcfL.js";import{B as ve}from"./BaseModal-D8J9ah1e.js";const de=ze("gallery",()=>{const o=g([]),V=g([]),C=g(null),B=g(!1),$=g(null),M=g(""),u=g("created_at"),p=g("desc"),S=g("all"),b=g({}),d=g([]),m=g([]),N=re(),E=r=>r?r.startsWith("http://")||r.startsWith("https://")?r:r.startsWith("/uploads/")?`${window.location.origin}${r}`:r:"",P=async(r,w=null,T=null)=>{const L=new FormData;r.forEach(H=>{L.append("images",H)}),w&&Array.isArray(w)&&L.append("items",JSON.stringify(w));const q=N.createUploadNotification({totalFiles:r.length,files:r.map(H=>({name:H.name,size:H.size}))});try{const H=await ee.post("/gallery/upload",L,{headers:{"Content-Type":"multipart/form-data"},onUploadProgress:K=>{if(K.total&&T){const Y=Math.round(K.loaded*100/K.total);T(Y,r.length,r.length),N.updateUploadProgress(q,{progress:Y,currentFile:Math.floor(Y/100*r.length),totalFiles:r.length,status:"uploading"})}}});if(H.data.items&&Array.isArray(H.data.items)){const K=H.data.items.map(Y=>({...Y,image_url:E(Y.image_url)}));o.value.unshift(...K)}return N.updateUploadProgress(q,{status:"completed",progress:100,currentFile:r,filesCompleted:r.length,totalFiles:r.length}),{success:!0,data:H.data}}catch(H){return console.error("Upload error:",H.response?.data),$.value=H.response?.data?.error||"Failed to upload items",N.updateUploadProgress(q,{status:"error",error:$.value}),{success:!1,error:$.value}}},x=async(r=1)=>{B.value=!0,$.value=null;try{const w={page:r,limit:20,sortBy:u.value,sortOrder:p.value,q:M.value,status:S.value};S.value==="my"&&(w.my="true");const L=(await ee.get("/gallery",{params:w})).data.map(q=>({...q,image_url:E(q.image_url)}));return r===1?o.value=L:o.value.push(...L),{success:!0,data:L}}catch(w){return $.value=w.response?.data?.error||"Failed to fetch gallery items",{success:!1,error:$.value}}finally{B.value=!1}},z=async r=>{try{const w=await ee.get(`/gallery/${r}`);return C.value={...w.data,image_url:E(w.data.image_url)},{success:!0,data:C.value}}catch(w){return $.value=w.response?.data?.error||"Failed to fetch item",{success:!1,error:$.value}}},h=async r=>{try{const w=await ee.post("/gallery/upload",r),T={...w.data,image_url:E(w.data.image_url)};return o.value.unshift(T),{success:!0,data:T}}catch(w){return console.error("Create item error:",w.response?.data),$.value=w.response?.data?.error||"Failed to create item",{success:!1,error:$.value}}},k=async(r,w)=>{const T=w instanceof FormData;try{const L={headers:{}};T&&(L.headers["Content-Type"]="multipart/form-data");const q=await ee.put(`/gallery/${r}`,w,L),H={...q.data.data,image_url:E(q.data.data.image_url)},K=o.value.findIndex(Y=>Y.id===r);return K!==-1&&(o.value[K]=H),{success:!0,data:H}}catch(L){return console.error("Update item error:",L.response?.data),$.value=L.response?.data?.error||"Failed to update item",{success:!1,error:$.value,details:L.response?.data?.details}}},A=async r=>{try{await ee.delete(`/gallery/${r}`);const w=o.value.findIndex(T=>T.id===r);return w!==-1&&o.value.splice(w,1),{success:!0}}catch(w){return console.error("Delete item error:",w.response?.data),$.value=w.response?.data?.error||"Failed to delete item",{success:!1,error:$.value}}},i=async r=>(M.value=r,await x(1)),n=(r,w)=>(u.value=r,p.value=w,x(1)),v=r=>(S.value=r,x(1)),s=async()=>{try{return{success:!0,data:(await ee.get("/gallery/statistics")).data}}catch(r){return console.error("Failed to get statistics:",r),{success:!1,error:r.message}}},t=async r=>{try{const w=await ee.put(`/gallery/${r}/validate`),T=o.value.findIndex(L=>L.id===r);return T!==-1&&(o.value[T]=w.data),{success:!0,data:w.data}}catch(w){return console.error("Validate item error:",w),{success:!1,error:w.message}}},F=()=>{const r=m.value.length,w=m.value.filter(L=>L.status==="completed").length,T=m.value.filter(L=>L.status==="error").length;return{total:r,successful:w,failed:T}},W=()=>{m.value=[]};return{items:o,publicItems:V,currentItem:C,isLoading:B,error:$,searchQuery:M,sortBy:u,sortOrder:p,filterStatus:S,uploadProgress:b,activeUploads:d,uploadHistory:m,totalItems:j(()=>o.value.length),getItems:x,getItem:z,createItem:h,updateItem:k,deleteItem:A,uploadItems:P,searchItems:i,setSort:n,setFilter:v,getStatistics:s,validateItem:t,getFullImageUrl:E,getUploadStats:F,clearUploadHistory:W}}),Ve={class:"upload-component"},xe={class:"multiple-upload"},Ne=["accept","disabled"],Ee={class:"upload-icon"},De={class:"upload-hint"},Oe={key:0,class:"files-list"},Ae={class:"file-preview"},Le=["src"],Pe={key:1,class:"file-icon"},Te={class:"file-info"},He={class:"file-name"},Re={class:"file-size"},Ge={key:0,class:"file-fields"},We={class:"form-group"},Je=["onUpdate:modelValue","disabled","onInput"],je={class:"form-group"},qe=["onUpdate:modelValue","disabled","onInput"],Ke={class:"form-group"},Qe=["onUpdate:modelValue","disabled","onInput"],Xe={class:"form-group"},Ye=["onUpdate:modelValue","disabled","onInput"],Ze={class:"form-group"},et=["onUpdate:modelValue","disabled","onInput"],tt={class:"file-actions"},st=["onClick","disabled"],at={key:0,class:"upload-progress"},lt={class:"progress-bar"},ot={class:"progress-text"},it={key:1,class:"error-message"},nt={__name:"UploadComponent",props:{mode:{type:String,default:"multiple",validator:o=>["single","multiple"].includes(o)},accept:{type:String,default:"image/*"},maxSizeMB:{type:Number,default:10},withFields:{type:Boolean,default:!1},modelValue:{type:[File,Array],default:null},disabled:{type:Boolean,default:!1}},emits:["update:modelValue","files-updated"],setup(o,{expose:V,emit:C}){const B=o,$=C,M=g(null),u=g(!1),p=g([]),S=g(0),b=g(""),d=()=>{B.disabled||M.value.click()},m=i=>{const v=Array.from(i.target.files).filter(s=>E(s));P(v)},N=i=>{u.value=!1;const v=Array.from(i.dataTransfer.files).filter(s=>E(s));P(v)},E=i=>{if(b.value="",!i)return!1;if(!i.type.match("image.*"))return b.value="Разрешены только изображения",!1;const n=B.maxSizeMB*1024*1024;return i.size>n?(b.value=`Размер файла не должен превышать ${B.maxSizeMB}MB`,!1):!0},P=i=>{const n=i.map(v=>{const s=URL.createObjectURL(v);return{file:v,name:v.name,size:v.size,preview:s,title:"",description:"",artist:"",year:"",tags:""}});p.value=[...p.value,...n],z()},x=(i,n,v)=>{p.value[i][n]=v,z()},z=()=>{const i=p.value.map(n=>({file:n.file,title:n.title,description:n.description,artist:n.artist,year:n.year,tags:n.tags}));$("files-updated",i),$("update:modelValue",p.value.map(n=>n.file))},h=i=>{p.value[i].preview&&URL.revokeObjectURL(p.value[i].preview),p.value.splice(i,1),z()},k=i=>{if(!i)return"0 Bytes";const n=1024,v=["Bytes","KB","MB","GB"],s=Math.floor(Math.log(i)/Math.log(n));return parseFloat((i/Math.pow(n,s)).toFixed(2))+" "+v[s]},A=()=>{p.value=[],b.value="",S.value=0,$("update:modelValue",null),$("files-updated",[])};return V({reset:A}),ue(()=>B.modelValue,i=>{i||A()},{immediate:!0}),(i,n)=>(a(),l("div",Ve,[e("div",xe,[e("div",{class:se(["upload-area",{"drag-over":u.value}]),onClick:d,onDragover:n[0]||(n[0]=ae(v=>u.value=!0,["prevent"])),onDragleave:n[1]||(n[1]=v=>u.value=!1),onDrop:ae(N,["prevent"])},[e("input",{ref_key:"fileInput",ref:M,type:"file",accept:o.accept,multiple:"",onChange:m,disabled:o.disabled,style:{display:"none"}},null,40,Ne),e("div",Ee,[U(O,{name:"upload",size:48})]),n[2]||(n[2]=e("p",{class:"upload-text"},"Нажмите или перетащите файлы для загрузки",-1)),e("p",De,"Максимальный размер: "+f(o.maxSizeMB)+"MB на файл",1)],34),p.value.length>0?(a(),l("div",Oe,[(a(!0),l(le,null,oe(p.value,(v,s)=>(a(),l("div",{key:s,class:"file-item"},[e("div",Ae,[v.preview?(a(),l("img",{key:0,src:v.preview,alt:""},null,8,Le)):(a(),l("div",Pe,[U(O,{name:"file",size:32})]))]),e("div",Te,[e("p",He,f(v.name),1),e("p",Re,f(k(v.size)),1),o.withFields?(a(),l("div",Ge,[e("div",We,[J(e("input",{"onUpdate:modelValue":t=>v.title=t,placeholder:"Название",class:"field-input",disabled:o.disabled,onInput:t=>x(s,"title",t.target.value)},null,40,Je),[[X,v.title]])]),e("div",je,[J(e("textarea",{"onUpdate:modelValue":t=>v.description=t,placeholder:"Описание",rows:"2",class:"field-input",disabled:o.disabled,onInput:t=>x(s,"description",t.target.value)},null,40,qe),[[X,v.description]])]),e("div",Ke,[J(e("input",{"onUpdate:modelValue":t=>v.artist=t,placeholder:"Художник",class:"field-input",disabled:o.disabled,onInput:t=>x(s,"artist",t.target.value)},null,40,Qe),[[X,v.artist]])]),e("div",Xe,[J(e("input",{"onUpdate:modelValue":t=>v.year=t,placeholder:"Год",type:"number",class:"field-input",disabled:o.disabled,onInput:t=>x(s,"year",t.target.value)},null,40,Ye),[[X,v.year]])]),e("div",Ze,[J(e("input",{"onUpdate:modelValue":t=>v.tags=t,placeholder:"Теги (через запятую)",class:"field-input",disabled:o.disabled,onInput:t=>x(s,"tags",t.target.value)},null,40,et),[[X,v.tags]])])])):_("",!0)]),e("div",tt,[e("button",{onClick:t=>h(s),class:"remove-btn",disabled:o.disabled},[U(O,{name:"trash",size:24})],8,st)])]))),128))])):_("",!0)]),S.value>0&&S.value<100?(a(),l("div",at,[e("div",lt,[e("div",{class:"progress-fill",style:ie({width:`${S.value}%`})},null,4)]),e("p",ot,f(S.value)+"%",1)])):_("",!0),b.value?(a(),l("div",it,[e("p",null,f(b.value),1)])):_("",!0)]))}},rt=ne(nt,[["__scopeId","data-v-d4b4383a"]]),dt=(o,V=20)=>{if(!o)return"";if(o.length<=V)return o;const C=o.split(".").pop();return`${o.substring(0,V-8)}... .${C}`},ut={class:"upload-container"},ct={class:"upload-info"},vt={key:0,class:"overall-progress"},pt={class:"progress-header"},mt={class:"progress-stats"},gt={class:"progress-percent"},ft={class:"progress-bar"},ht={key:0,class:"files-progress"},yt={class:"file-info"},_t={class:"file-name"},$t={class:"file-progress-bar"},wt={class:"file-progress-text"},kt={__name:"UploadModal",props:{show:{type:Boolean,default:!1}},emits:["update:show","close","uploaded"],setup(o,{emit:V}){const C=V,B=de(),$=re(),M=g(null),u=g([]),p=g(!1),S=g(0),b=g(0),d=g(0),m=j(()=>p.value?`Загрузка... ${S.value}%`:`Загрузить ${u.value?.length||0} файлов`),N=i=>{u.value=i.map(n=>({...n,status:"pending",progress:0,error:null})),d.value=i.length},E=i=>{switch(i){case"uploading":return"loader";case"success":return"check-circle";case"error":return"alert-circle";default:return"clock"}},P=i=>{C("update:show",i),i||x()},x=()=>{p.value?(C("update:show",!1),h()):(C("close"),C("update:show",!1))},z=()=>{x()},h=()=>{const i={files:u.value,overallProgress:S.value,currentUploaded:b.value,totalFiles:d.value,timestamp:Date.now()};localStorage.setItem("gallery_upload_session",JSON.stringify(i)),$.addNotification({type:"info",title:"Загрузка продолжается в фоне",message:"Вы можете отслеживать прогресс в центре уведомлений",duration:3e3})},k=async()=>{if(u.value?.length){p.value=!0,S.value=0,b.value=0;try{const i=u.value.map(s=>s.file),n=u.value.map(s=>({filename:s.file.name,title:s.title||"",description:s.description||"",artist:s.artist||"",year:s.year?parseInt(s.year):null,tags:s.tags||"",is_valid:!1})),v=await B.uploadItems(i,n,(s,t,F)=>{S.value=s,b.value=t,u.value.forEach((W,r)=>{r<t?(W.status="success",W.progress=100):r===t&&(W.status="uploading",W.progress=s%100)})});if(!v.success)throw new Error(v.error);C("uploaded",u.value),x()}catch(i){console.error("Upload error:",i),$.addNotification({type:"error",title:"Ошибка загрузки",message:i.message||"Произошла ошибка при загрузке"})}finally{p.value=!1}}},A=()=>{const i=localStorage.getItem("gallery_upload_session");if(i)try{const n=JSON.parse(i);u.value=n.files||[],S.value=n.overallProgress||0,b.value=n.currentUploaded||0,d.value=n.totalFiles||0,n.overallProgress>0&&n.overallProgress<100&&$.addNotification({type:"info",title:"Незавершенная загрузка",message:"У вас есть незавершенная загрузка. Вы можете продолжить ее.",duration:5e3})}catch(n){console.error("Error restoring upload session:",n)}};return ce(()=>{A()}),Me(()=>{p.value||localStorage.removeItem("gallery_upload_session")}),(i,n)=>(a(),Q(ve,{show:o.show,"onUpdate:show":P,onClose:x,onOverlayClick:z,title:"Загрузить изображения в галерею",size:"lg","close-on-overlay":!1,"close-on-esc":!1,closable:!p.value,"show-footer":!0},{footer:D(()=>[U(R,{variant:"outline",onClick:x,disabled:p.value},{default:D(()=>[G(f(p.value?"Скрыть":"Отмена"),1)]),_:1},8,["disabled"]),U(R,{onClick:k,disabled:p.value||!u.value?.length,loading:p.value},{default:D(()=>[G(f(m.value),1)]),_:1},8,["disabled","loading"])]),default:D(()=>[e("div",ut,[e("div",ct,[U(O,{name:"info",size:20}),n[0]||(n[0]=e("p",null,"Изображения будут сразу сохранены в вашу галерею. Вы сможете добавить информацию позже.",-1))]),U(rt,{ref_key:"uploadComponent",ref:M,mode:"multiple",withFields:!0,disabled:p.value,onFilesUpdated:N,class:"uploader"},null,8,["disabled"]),p.value?(a(),l("div",vt,[e("div",pt,[n[1]||(n[1]=e("h3",null,"Загрузка файлов",-1)),e("div",mt,[G(f(b.value)+"/"+f(d.value)+" файлов ",1),e("span",gt,f(S.value)+"%",1)])]),e("div",ft,[e("div",{class:"progress-fill",style:ie({width:S.value+"%"})},null,4)]),u.value?.length>0?(a(),l("div",ht,[(a(!0),l(le,null,oe(u.value,(v,s)=>(a(),l("div",{key:s,class:"file-progress-item"},[e("div",yt,[U(O,{name:E(v.status),size:16,class:se(v.status)},null,8,["name","class"]),e("span",_t,f(te(dt)(v.file?.name)),1)]),e("div",$t,[e("div",{class:se(["progress-fill",v.status]),style:ie({width:v.progress+"%"})},null,6)]),e("span",wt,f(v.progress)+"%",1)]))),128))])):_("",!0)])):_("",!0)])]),_:1},8,["show","closable"]))}},bt=ne(kt,[["__scopeId","data-v-ce0076c4"]]),Ut={class:"upload-progress-container"},It={key:0,class:"badge"},Ct={key:1,class:"error-badge"},Ft={key:1,class:"progress-panel"},St={class:"panel-header"},zt={key:0,class:"active-uploads"},Mt={class:"upload-info"},Bt={class:"filename"},Vt={class:"file-size"},xt={class:"upload-progress"},Nt={class:"progress-bar"},Et={class:"progress-text"},Dt={key:0},Ot={key:1,class:"success"},At={key:2,class:"error"},Lt={key:0,class:"error-message"},Pt={key:1,class:"upload-history"},Tt={class:"history-header"},Ht={class:"history-list"},Rt={class:"history-icon"},Gt={class:"history-info"},Wt={class:"history-filename"},Jt={class:"history-time"},jt={class:"history-size"},qt={key:0,class:"show-more"},Kt={key:2,class:"upload-stats"},Qt={class:"stat-item"},Xt={class:"stat-value"},Yt={class:"stat-item"},Zt={class:"stat-value success"},es={class:"stat-item"},ts={class:"stat-value error"},ss={key:3,class:"empty-state"},as={__name:"UploadProgress",setup(o){const V=de(),C=re(),B=g(!1),$=g(!1),M=j(()=>V.activeUploads.length),u=j(()=>V.activeUploads.filter(z=>z.status==="error").length),p=j(()=>M.value>0),S=j(()=>u.value>0),b=j(()=>V.uploadHistory.length>0),d=j(()=>$.value?V.uploadHistory:V.uploadHistory.slice(0,5)),m=j(()=>V.getUploadStats()),N=()=>{B.value=!B.value},E=z=>{if(!z)return"";if(z.length<=20)return z;const h=z.split(".").pop();return`${z.substring(0,15)}... .${h}`},P=z=>{if(!z)return"0 Bytes";const h=1024,k=["Bytes","KB","MB","GB"],A=Math.floor(Math.log(z)/Math.log(h));return parseFloat((z/Math.pow(h,A)).toFixed(2))+" "+k[A]},x=z=>{if(!z)return"";const h=new Date(z),A=new Date-h,i=Math.floor(A/6e4),n=Math.floor(A/36e5);return i<1?"Только что":i<60?`${i} мин назад`:n<24?`${n} ч назад`:h.toLocaleDateString("ru-RU")};return ue(()=>M.value,(z,h)=>{if(z===0&&h>0){const k=V.uploadHistory.filter(A=>A.status==="completed"&&new Date-new Date(A.completedAt)<1e3).length;k>0&&C.addNotification({type:"success",title:"Загрузка завершена",message:`Успешно загружено ${k} файлов`,duration:5e3})}}),(z,h)=>(a(),l("div",Ut,[p.value&&!B.value?(a(),l("button",{key:0,class:se(["floating-btn",{"has-errors":S.value}]),onClick:N},[U(O,{name:"upload",size:20}),M.value>0?(a(),l("span",It,f(M.value),1)):_("",!0),u.value>0?(a(),l("span",Ct,f(u.value),1)):_("",!0)],2)):_("",!0),B.value?(a(),l("div",Ft,[e("div",St,[h[1]||(h[1]=e("h3",null,"Загрузка изображений",-1)),U(R,{size:"sm",variant:"ghost",onClick:N},{default:D(()=>[U(O,{name:"close",size:20})]),_:1})]),p.value?(a(),l("div",zt,[e("h4",null,"В процессе ("+f(M.value)+")",1),(a(!0),l(le,null,oe(te(V).activeUploads,k=>(a(),l("div",{key:k.id,class:"upload-item"},[e("div",Mt,[e("div",Bt,f(E(k.filename)),1),e("div",Vt,f(P(k.file?.size)),1)]),e("div",xt,[e("div",Nt,[e("div",{class:se(["progress-fill",{"progress-success":k.status==="completed","progress-error":k.status==="error"}]),style:ie({width:k.progress+"%"})},null,6)]),e("div",Et,[k.status==="uploading"?(a(),l("span",Dt,f(k.progress)+"%",1)):k.status==="completed"?(a(),l("span",Ot,[U(O,{name:"check",size:14}),h[2]||(h[2]=G(" Загружено ",-1))])):k.status==="error"?(a(),l("span",At,[U(O,{name:"alert-circle",size:14}),h[3]||(h[3]=G(" Ошибка ",-1))])):_("",!0)])]),k.status==="error"?(a(),l("div",Lt,f(k.error),1)):_("",!0)]))),128))])):_("",!0),b.value?(a(),l("div",Pt,[e("div",Tt,[h[5]||(h[5]=e("h4",null,"История загрузок",-1)),te(V).uploadHistory.length>0?(a(),Q(R,{key:0,size:"sm",variant:"ghost",onClick:te(V).clearUploadHistory},{default:D(()=>[...h[4]||(h[4]=[G(" Очистить ",-1)])]),_:1},8,["onClick"])):_("",!0)]),e("div",Ht,[(a(!0),l(le,null,oe(d.value,(k,A)=>(a(),l("div",{key:A,class:se(["history-item",{"history-success":k.status==="completed","history-error":k.status==="error"}])},[e("div",Rt,[U(O,{name:k.status==="completed"?"check-circle":"alert-circle",size:16},null,8,["name"])]),e("div",Gt,[e("div",Wt,f(E(k.filename)),1),e("div",Jt,f(x(k.completedAt)),1)]),e("div",jt,f(P(k.file?.size)),1)],2))),128))]),te(V).uploadHistory.length>5?(a(),l("div",qt,[U(R,{variant:"link",size:"sm",onClick:h[0]||(h[0]=k=>$.value=!$.value)},{default:D(()=>[G(f($.value?"Скрыть":`Показать еще ${te(V).uploadHistory.length-5}`),1)]),_:1})])):_("",!0)])):_("",!0),m.value.total>0?(a(),l("div",Kt,[e("div",Qt,[e("div",Xt,f(m.value.total),1),h[6]||(h[6]=e("div",{class:"stat-label"},"Всего загрузок",-1))]),e("div",Yt,[e("div",Zt,f(m.value.successful),1),h[7]||(h[7]=e("div",{class:"stat-label"},"Успешно",-1))]),e("div",es,[e("div",ts,f(m.value.failed),1),h[8]||(h[8]=e("div",{class:"stat-label"},"С ошибками",-1))])])):_("",!0),!p.value&&!b.value?(a(),l("div",ss,[U(O,{name:"upload-cloud",size:48}),h[9]||(h[9]=e("p",null,"Нет активных загрузок",-1))])):_("",!0)])):_("",!0)]))}},ls=ne(as,[["__scopeId","data-v-c5161686"]]),os={class:"view-container"},is={class:"image-viewer"},ns=["src","alt"],rs={class:"details-panel"},ds={class:"detail-section"},us={key:0,class:"detail-item"},cs={class:"detail-value"},vs={key:1,class:"detail-item"},ps={class:"detail-value"},ms={key:2,class:"detail-item"},gs={class:"detail-value"},fs={key:3,class:"detail-item"},hs={class:"detail-value"},ys={key:0,class:"detail-section"},_s={class:"description"},$s={key:1,class:"detail-section"},ws={class:"tags"},ks={key:2,class:"detail-section"},bs={class:"validation-notice"},Us={__name:"ViewModal",props:{show:{type:Boolean,default:!1},item:{type:Object,required:!0}},emits:["update:show","close","edit"],setup(o,{emit:V}){const C=o,B=V,$=fe(),M=j(()=>$.user&&$.user.id===C.item.user_id),u=()=>{B("edit",C.item)},p=b=>b?b.split(",").map(d=>d.trim()).filter(d=>d):[],S=b=>new Date(b).toLocaleDateString("ru-RU",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return(b,d)=>(a(),Q(ve,{show:o.show,"onUpdate:show":d[1]||(d[1]=m=>b.$emit("update:show",m)),onClose:d[2]||(d[2]=m=>b.$emit("close")),title:o.item.title||"Без названия",size:"xl","close-on-overlay":!0,"close-on-esc":!0,"show-footer":!0},{footer:D(()=>[U(R,{variant:"outline",onClick:d[0]||(d[0]=m=>b.$emit("close"))},{default:D(()=>[...d[11]||(d[11]=[G("Закрыть",-1)])]),_:1}),M.value?(a(),Q(R,{key:0,onClick:u},{default:D(()=>[...d[12]||(d[12]=[G("Редактировать",-1)])]),_:1})):_("",!0)]),default:D(()=>[e("div",os,[e("div",is,[e("img",{src:o.item.image_url,alt:o.item.title,class:"main-image"},null,8,ns)]),e("div",rs,[e("div",ds,[d[7]||(d[7]=e("h3",null,"Информация о работе",-1)),o.item.artist?(a(),l("div",us,[d[3]||(d[3]=e("span",{class:"detail-label"},"Художник:",-1)),e("span",cs,f(o.item.artist),1)])):_("",!0),o.item.year?(a(),l("div",vs,[d[4]||(d[4]=e("span",{class:"detail-label"},"Год создания:",-1)),e("span",ps,f(o.item.year),1)])):_("",!0),o.item.created_at?(a(),l("div",ms,[d[5]||(d[5]=e("span",{class:"detail-label"},"Добавлено:",-1)),e("span",gs,f(S(o.item.created_at)),1)])):_("",!0),o.item.user?(a(),l("div",fs,[d[6]||(d[6]=e("span",{class:"detail-label"},"Автор:",-1)),e("span",hs,f(o.item.user.name||o.item.user.email),1)])):_("",!0)]),o.item.description?(a(),l("div",ys,[d[8]||(d[8]=e("h3",null,"Описание",-1)),e("p",_s,f(o.item.description),1)])):_("",!0),o.item.tags?(a(),l("div",$s,[d[9]||(d[9]=e("h3",null,"Теги",-1)),e("div",ws,[(a(!0),l(le,null,oe(p(o.item.tags),m=>(a(),l("span",{key:m,class:"tag"},f(m),1))),128))])])):_("",!0),o.item.is_valid?_("",!0):(a(),l("div",ks,[e("div",bs,[U(O,{name:"alert-circle",size:20}),d[10]||(d[10]=e("p",null,"Эта работа находится на проверке.",-1))])]))])])]),_:1},8,["show","title"]))}},Is=ne(Us,[["__scopeId","data-v-d168720a"]]),Cs={class:"edit-form"},Fs={class:"image-section"},Ss={class:"current-image"},zs=["src","alt"],Ms={class:"image-upload"},Bs=["disabled"],Vs={key:0,class:"new-image-preview"},xs=["src"],Ns={class:"preview-actions"},Es={class:"form-section"},Ds={class:"form-group"},Os=["disabled"],As={class:"form-group"},Ls=["disabled"],Ps={class:"form-row"},Ts={class:"form-group"},Hs=["disabled"],Rs={class:"form-group"},Gs=["disabled"],Ws={class:"form-group"},Js=["disabled"],js={class:"form-group"},qs={class:"checkbox-label"},Ks=["disabled"],Qs={key:0,class:"save-progress"},Xs={class:"progress-bar"},Ys={__name:"EditGalleryModal",props:{show:{type:Boolean,default:!1},item:{type:Object,required:!0}},emits:["update:show","close","saved"],setup(o,{emit:V}){const C=o,B=V,$=de(),M=re(),u=g({}),p=g(null),S=g(""),b=g(null),d=g(!1),m=g(!1),N=g(0),E=g(!1);ce(()=>{u.value={...C.item},ue(()=>u.value,(s,t)=>{JSON.stringify(s)!==JSON.stringify(t)&&(E.value=!0)},{deep:!0})});const P=s=>s?s.startsWith("http://")||s.startsWith("https://")?s:s.startsWith("/uploads/")?window.location.origin+s:s:"",x=()=>{!m.value&&b.value&&b.value.click()},z=s=>{const t=s.target.files[0];if(t&&k(t)){p.value=t;const F=new FileReader;F.onload=W=>{S.value=W.target.result},F.readAsDataURL(t),E.value=!0}},h=s=>{d.value=!1;const t=s.dataTransfer.files[0];if(t&&k(t)){p.value=t;const F=new FileReader;F.onload=W=>{S.value=W.target.result},F.readAsDataURL(t),E.value=!0}},k=s=>s.type.match("image.*")?s.size>10*1024*1024?(M.addNotification({type:"error",title:"Ошибка",message:"Размер файла не должен превышать 10MB"}),!1):!0:(M.addNotification({type:"error",title:"Ошибка",message:"Разрешены только изображения"}),!1),A=()=>{p.value=null,S.value="",b.value&&(b.value.value="")},i=()=>{E.value&&!m.value?confirm("У вас есть несохраненные изменения. Вы уверены, что хотите закрыть?")&&B("close"):B("close")},n=()=>{i()},v=async()=>{m.value=!0,N.value=30;try{const s={...u.value};if(delete s.image_url,delete s.created_at,delete s.updated_at,s.tags){let t;typeof s.tags=="string"?t=s.tags.split(",").map(F=>F.trim()).filter(F=>F):Array.isArray(s.tags)&&(t=s.tags),s.tags=JSON.stringify(t||[])}if(typeof s.is_valid=="boolean"&&(s.is_valid=s.is_valid.toString()),p.value){N.value=50;const t=new FormData;t.append("image",p.value),Object.keys(s).forEach(W=>{const r=s[W];r!=null&&t.append(W,r)});const F=await $.updateItem(C.item.id,t);if(F.success)N.value=100,B("saved",F.data),M.addNotification({type:"success",title:"Работа обновлена",message:"Изображение и информация успешно обновлены"}),B("update:show",!1);else throw new Error(F.error||"Не удалось обновить работу")}else{N.value=80;const t=await $.updateItem(C.item.id,s);if(t.success)N.value=100,B("saved",t.data),M.addNotification({type:"success",title:"Работа обновлена",message:"Информация успешно обновлена"}),B("update:show",!1);else throw new Error(t.error||"Не удалось обновить работу")}}catch(s){console.error("Save error:",s),M.addNotification({type:"error",title:"Ошибка сохранения",message:s.message||"Не удалось сохранить изменения"})}finally{m.value=!1,N.value=0}};return(s,t)=>(a(),Q(ve,{show:o.show,"onUpdate:show":t[8]||(t[8]=F=>s.$emit("update:show",F)),onClose:i,onOverlayClick:n,title:"Редактирование работы",size:"lg","close-on-overlay":!1,"close-on-esc":!1,disabled:m.value,"show-footer":!0},{footer:D(()=>[U(R,{variant:"outline",onClick:i,disabled:m.value},{default:D(()=>[...t[19]||(t[19]=[G(" Отмена ",-1)])]),_:1},8,["disabled"]),U(R,{onClick:v,disabled:m.value,loading:m.value},{default:D(()=>[...t[20]||(t[20]=[G(" Сохранить изменения ",-1)])]),_:1},8,["disabled","loading"])]),default:D(()=>[e("div",Cs,[e("div",Fs,[e("div",Ss,[e("img",{src:P(u.value.image_url),alt:u.value.title},null,8,zs)]),e("div",Ms,[e("div",{class:se(["upload-area",{"drag-over":d.value}]),onClick:x,onDragover:t[0]||(t[0]=ae(F=>d.value=!0,["prevent"])),onDragleave:t[1]||(t[1]=F=>d.value=!1),onDrop:ae(h,["prevent"]),style:ie({pointerEvents:m.value?"none":"auto"})},[e("input",{ref_key:"fileInput",ref:b,type:"file",accept:"image/*",onChange:z,style:{display:"none"},disabled:m.value},null,40,Bs),U(O,{name:"upload",size:32}),t[9]||(t[9]=e("p",null,"Нажмите для загрузки нового изображения",-1)),t[10]||(t[10]=e("p",{class:"file-hint"},"Максимальный размер: 10MB",-1))],38),p.value?(a(),l("div",Vs,[e("img",{src:S.value,alt:"Новое изображение"},null,8,xs),e("div",Ns,[U(R,{size:"sm",variant:"outline",onClick:A,disabled:m.value},{default:D(()=>[...t[11]||(t[11]=[G(" Отмена ",-1)])]),_:1},8,["disabled"])])])):_("",!0)])]),e("div",Es,[e("div",Ds,[t[12]||(t[12]=e("label",null,"Название работы",-1)),J(e("input",{"onUpdate:modelValue":t[2]||(t[2]=F=>u.value.title=F),placeholder:"Введите название",disabled:m.value},null,8,Os),[[X,u.value.title]])]),e("div",As,[t[13]||(t[13]=e("label",null,"Описание",-1)),J(e("textarea",{"onUpdate:modelValue":t[3]||(t[3]=F=>u.value.description=F),placeholder:"Введите описание",rows:"4",disabled:m.value},null,8,Ls),[[X,u.value.description]])]),e("div",Ps,[e("div",Ts,[t[14]||(t[14]=e("label",null,"Художник",-1)),J(e("input",{"onUpdate:modelValue":t[4]||(t[4]=F=>u.value.artist=F),placeholder:"Имя художника",disabled:m.value},null,8,Hs),[[X,u.value.artist]])]),e("div",Rs,[t[15]||(t[15]=e("label",null,"Год создания",-1)),J(e("input",{"onUpdate:modelValue":t[5]||(t[5]=F=>u.value.year=F),type:"number",min:"1000",max:"2100",placeholder:"Год",disabled:m.value},null,8,Gs),[[X,u.value.year]])])]),e("div",Ws,[t[16]||(t[16]=e("label",null,"Теги (через запятую)",-1)),J(e("input",{"onUpdate:modelValue":t[6]||(t[6]=F=>u.value.tags=F),placeholder:"живопись, пейзаж, масло...",disabled:m.value},null,8,Js),[[X,u.value.tags]])]),e("div",js,[e("label",qs,[J(e("input",{"onUpdate:modelValue":t[7]||(t[7]=F=>u.value.is_valid=F),type:"checkbox",disabled:m.value},null,8,Ks),[[Be,u.value.is_valid]]),t[17]||(t[17]=e("span",null,"Отметить как валидную (видно всем)",-1))])])])]),m.value?(a(),l("div",Qs,[e("div",Xs,[e("div",{class:"progress-fill",style:ie({width:N.value+"%"})},null,4)]),t[18]||(t[18]=e("p",null,"Сохранение изменений...",-1))])):_("",!0)]),_:1},8,["show","disabled"]))}},Zs=ne(Ys,[["__scopeId","data-v-697febb4"]]),ea={class:"gallery-page"},ta={class:"container"},sa={class:"controls-panel"},aa={class:"controls-left"},la={class:"search-box"},oa={class:"controls-right"},ia={class:"sort-controls"},na={class:"filter-controls"},ra={key:0,class:"statistics-panel"},da={class:"stat-item"},ua={class:"stat-value"},ca={class:"stat-item"},va={class:"stat-value"},pa={class:"stat-item"},ma={class:"stat-value"},ga={class:"stat-item"},fa={class:"stat-value"},ha={key:1,class:"loading-state"},ya={key:2,class:"error-state"},_a={class:"error-message"},$a={key:3,class:"empty-state"},wa={class:"empty-message"},ka={key:4,class:"gallery-grid"},ba=["onClick"],Ua={class:"item-image-container"},Ia=["src","alt","onError"],Ca={key:1,class:"image-error-placeholder"},Fa={key:2,class:"invalid-badge"},Sa={class:"item-overlay"},za={class:"overlay-actions"},Ma={class:"item-info"},Ba={class:"item-title"},Va={key:0,class:"item-meta"},xa={key:0,class:"artist"},Na={key:1,class:"year"},Ea={key:1,class:"item-description"},Da={key:2,class:"item-tags"},Oa=["onClick"],Aa={key:5,class:"load-more"},La={__name:"Gallery",setup(o){const V=g({}),C=de(),B=fe(),$=re(),M=g(""),u=g("created_at"),p=g("desc"),S=g("all"),b=g(!1),d=g(!1),m=g(!1),N=g(null),E=g(null),P=g(null),x=g(1),z=j(()=>C.items),h=j(()=>C.isLoading),k=j(()=>C.error),A=y=>B.user&&B.user.id===y.user_id;ce(async()=>{await i(),await n()});const i=async()=>{x.value=1,await C.getItems(x.value)},n=async()=>{if(B.user){const y=await C.getStatistics();y.success&&(P.value=y.data)}},v=Fe(()=>{x.value=1,C.searchItems(M.value)},300),s=()=>{M.value="",C.searchItems("")},t=()=>{p.value=p.value==="asc"?"desc":"asc",F()},F=()=>{x.value=1,C.setSort(u.value,p.value)},W=()=>{x.value=1,C.setFilter(S.value)},r=()=>{b.value=!0},w=y=>{b.value=y},T=()=>{b.value=!1},L=y=>{E.value=y,m.value=!0},q=y=>{m.value=y,y||(E.value=null)},H=()=>{m.value=!1,E.value=null},K=y=>{N.value=y,d.value=!0},Y=y=>{d.value=y,y||(N.value=null)},pe=()=>{d.value=!1,N.value=null},he=y=>{H(),K(y)},ye=y=>{const c=C.items.findIndex(I=>I.id===y.id);c!==-1&&(C.items[c]=y),n(),$.addNotification({type:"success",title:"Работа обновлена",message:"Информация о работе успешно обновлена"}),pe()},_e=y=>{i(),n(),$.addNotification({type:"success",title:"Загрузка завершена",message:`Успешно загружено ${y?.length||0} файлов`}),T()},$e=async y=>{if(confirm("Вы уверены, что хотите удалить эту работу?"))try{(await C.deleteItem(y)).success&&($.addNotification({type:"success",title:"Работа удалена",message:"Работа успешно удалена из галереи"}),await i(),await n())}catch{$.addNotification({type:"error",title:"Ошибка",message:"Не удалось удалить работу"})}},we=y=>{M.value=y,v()},ke=async()=>{x.value+=1,await C.getItems(x.value)},be=(y,c)=>!y||y.length<=c?y:y.substring(0,c)+"...",Ue=y=>y?y.split(",").map(c=>c.trim()).filter(c=>c):[],Ie=y=>!V.value[y.id],Ce=(y,c)=>{V.value[c]=!0,console.warn(`Image load error for item ${c}:`,y.target.src)};function Fe(y,c){let I;return function(...me){const Se=()=>{clearTimeout(I),y(...me)};clearTimeout(I),I=setTimeout(Se,c)}}return(y,c)=>(a(),l("div",ea,[e("div",ta,[c[15]||(c[15]=e("div",{class:"page-header"},[e("h1",{class:"page-title"},"Галерея"),e("p",{class:"page-subtitle"},"Информационно-справочная система художественной галереи")],-1)),e("div",sa,[e("div",aa,[e("div",la,[U(O,{name:"search",size:20,class:"search-icon"}),J(e("input",{"onUpdate:modelValue":c[0]||(c[0]=I=>M.value=I),type:"text",placeholder:"Поиск по названию, описанию, художнику...",onInput:c[1]||(c[1]=(...I)=>te(v)&&te(v)(...I)),class:"search-input"},null,544),[[X,M.value]]),M.value?(a(),Q(R,{key:0,size:"sm",variant:"ghost",onClick:s,class:"clear-search-btn"},{default:D(()=>[U(O,{name:"close",size:24})]),_:1})):_("",!0)])]),e("div",oa,[e("div",ia,[J(e("select",{"onUpdate:modelValue":c[2]||(c[2]=I=>u.value=I),onChange:F,class:"sort-select"},[...c[4]||(c[4]=[e("option",{value:"created_at"},"Дата добавления",-1),e("option",{value:"title"},"Название",-1),e("option",{value:"artist"},"Художник",-1),e("option",{value:"year"},"Год",-1)])],544),[[ge,u.value]]),U(R,{onClick:t,size:"sm",variant:"outline",class:"sort-order-btn"},{default:D(()=>[U(O,{name:p.value==="asc"?"arrow-up":"arrow-down",size:24},null,8,["name"])]),_:1})]),e("div",na,[J(e("select",{"onUpdate:modelValue":c[3]||(c[3]=I=>S.value=I),onChange:W,class:"filter-select"},[...c[5]||(c[5]=[e("option",{value:"all"},"Все работы",-1),e("option",{value:"valid"},"Валидные",-1),e("option",{value:"invalid"},"На проверке",-1),e("option",{value:"my"},"Мои работы",-1)])],544),[[ge,S.value]])]),U(R,{onClick:r,class:"add-btn"},{default:D(()=>[U(O,{name:"plus",size:24}),c[6]||(c[6]=G(" Добавить работу ",-1))]),_:1})])]),P.value?(a(),l("div",ra,[e("div",da,[e("div",ua,f(P.value.total),1),c[7]||(c[7]=e("div",{class:"stat-label"},"Всего работ",-1))]),e("div",ca,[e("div",va,f(P.value.valid),1),c[8]||(c[8]=e("div",{class:"stat-label"},"Валидные",-1))]),e("div",pa,[e("div",ma,f(P.value.invalid),1),c[9]||(c[9]=e("div",{class:"stat-label"},"На проверке",-1))]),e("div",ga,[e("div",fa,f(P.value.totalSize),1),c[10]||(c[10]=e("div",{class:"stat-label"},"Общий размер",-1))])])):_("",!0),h.value?(a(),l("div",ha,[...c[11]||(c[11]=[e("div",{class:"loading-spinner"},null,-1),e("p",null,"Загрузка галереи...",-1)])])):k.value?(a(),l("div",ya,[U(O,{name:"warning",size:48,class:"error-icon"}),e("p",_a,f(k.value),1),U(R,{onClick:i},{default:D(()=>[...c[12]||(c[12]=[G("Попробовать снова",-1)])]),_:1})])):z.value.length===0?(a(),l("div",$a,[U(O,{name:"logo",size:64,class:"empty-icon"}),e("p",wa,f(M.value?"По вашему запросу ничего не найдено":"В галерее пока нет работ"),1),U(R,{onClick:r,size:"lg"},{default:D(()=>[...c[13]||(c[13]=[G("Добавить первую работу",-1)])]),_:1})])):(a(),l("div",ka,[(a(!0),l(le,null,oe(z.value,I=>(a(),l("div",{key:I.id,class:se(["gallery-item",{"invalid-item":!I.is_valid&&S.value!=="my"}]),onClick:Z=>L(I)},[e("div",Ua,[Ie(I)?(a(),l("img",{key:0,src:I.image_url,alt:I.title,class:"item-image",onError:Z=>Ce(Z,I.id)},null,40,Ia)):(a(),l("div",Ca,[U(O,{name:"image",size:48})])),!I.is_valid&&S.value!=="my"?(a(),l("div",Fa,[U(O,{name:"clock",size:24}),c[14]||(c[14]=e("span",null,"На проверке",-1))])):_("",!0),e("div",Sa,[e("div",za,[A(I)?(a(),Q(R,{key:0,size:"sm",variant:"ghost",onClick:ae(Z=>K(I),["stop"]),class:"action-btn"},{default:D(()=>[U(O,{name:"edit",size:48})]),_:1},8,["onClick"])):_("",!0),A(I)?(a(),Q(R,{key:1,size:"sm",variant:"ghost",onClick:ae(Z=>$e(I.id),["stop"]),class:"action-btn"},{default:D(()=>[U(O,{name:"trash",size:48})]),_:1},8,["onClick"])):_("",!0)])])]),e("div",Ma,[e("h3",Ba,f(I.title||"Без названия"),1),I.artist||I.year?(a(),l("div",Va,[I.artist?(a(),l("span",xa,f(I.artist),1)):_("",!0),I.year?(a(),l("span",Na,f(I.year),1)):_("",!0)])):_("",!0),I.description?(a(),l("p",Ea,f(be(I.description,100)),1)):_("",!0),I.tags?(a(),l("div",Da,[(a(!0),l(le,null,oe(Ue(I.tags),Z=>(a(),l("span",{key:Z,class:"tag",onClick:ae(me=>we(Z),["stop"])},f(Z),9,Oa))),128))])):_("",!0)])],10,ba))),128))])),z.value.length>0&&z.value.length%20===0?(a(),l("div",Aa,[U(R,{onClick:ke,variant:"outline",disabled:h.value},{default:D(()=>[G(f(h.value?"Загрузка...":"Загрузить еще"),1)]),_:1},8,["disabled"])])):_("",!0)]),b.value?(a(),Q(bt,{key:0,show:b.value,"onUpdate:show":w,onClose:T,onUploaded:_e},null,8,["show"])):_("",!0),d.value?(a(),Q(Zs,{key:1,show:d.value,item:N.value,"onUpdate:show":Y,onClose:pe,onSaved:ye},null,8,["show","item"])):_("",!0),m.value?(a(),Q(Is,{key:2,show:m.value,item:E.value,"onUpdate:show":q,onClose:H,onEdit:he},null,8,["show","item"])):_("",!0),U(ls)]))}},Ha=ne(La,[["__scopeId","data-v-e4a5b151"]]);export{Ha as default};
